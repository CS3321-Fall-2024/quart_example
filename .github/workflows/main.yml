name: Deploy to EC2

on:
  push:
    branches:
      - feature/7-gh-actions-workflow

jobs:
  build:
    environment: development-scratch
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build Docker image
      run: |
        docker build -t ryandavis7/quart_example:latest .

    - name: Login to Docker registry
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Push Docker image to registry
      run: |
        docker push ryandavis7/quart_example:latest
  deploy:
    needs: build
    environment: development-scratch
    runs-on: ubuntu-latest

    steps:
    - name: Login to Docker registry
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Deploy to EC2
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        # Install AWS CLI
        sudo apt-get install -y awscli

        # Pull Docker image from registry
        docker pull ryandavis7/quart_example:latest

        # Deploy to EC2 instance
        aws ec2 run-instances \
          --image-id ami-0aafdae616ee7c9b7 \
          --instance-type t2.micro \
          --key-name quart_example \
          --security-group-ids sg-030d78031880267de \
          --user-data '#!/bin/bash
            echo 'hello world!'
